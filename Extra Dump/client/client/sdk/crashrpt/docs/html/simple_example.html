<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="icon" href="../favicon.ico" type="image/x-icon" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CrashRpt: An Example of Using CrashRpt API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>

<table border="0" bgcolor="#FFFFFF" cellspacing="5" width="100%">
 <tr>
  <td width="24px" rowspan="2"><img src="../logo.png" alt="Logo" /></td>
  <td><font family="Arial" size="+2">crashrpt</font></td>
  <td rowspan="2" align="right"><a href="http://sourceforge.net/donate/index.php?group_id=279722"><img src="../donate_small.png" alt="Donate" /></a></td>
 </tr>
 <tr>
  <td colspan="2"><i>A crash reporting system for Windows applications</i></td>
 </tr>


</table>


</body>
<!-- Generated by Doxygen 1.5.9 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Contents</span></a></li>
      <li><a href="modules.html"><span>API&nbsp;Reference</span></a></li>
      <li><a href="files.html"><span>File&nbsp;Reference</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">CrashRpt Documentation</a>&nbsp;&raquo&nbsp;<a class="el" href="using_crashrpt.html">Using CrashRpt in Your Project</a>
  </div>
</div>
<div class="contents">
<h1><a class="anchor" name="simple_example">An Example of Using CrashRpt API </a></h1>The following example shows how to use CrashRpt API functions and structures to enable crash reporting support. For additional information on CrashRpt API functions and structures, please refer to <a class="el" href="using_crashrpt_api.html">Using CrashRpt API</a>.<p>
First create a console WinAPI application and call it MyApp. Then configure the MyApp application as described in <a class="el" href="configuring_project.html">Configuring Your Project's Build Settings</a>.<p>
Let's assume the case when MyApp application has two threads. The first thread, the application thread, will be the main one. The <b>main()</b> function will be executed in this thread and interaction with user will also be done in this thread. The second thread, the worker thread, is usually used when some time-consuming computational work is to be done without blocking the application thread.<p>
The MyApp application will create a log file that will be included in error report on crash. The log file is typically helpful when debugging a crash.<p>
Let's create the code template.<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;windows.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;tchar.h&gt;</span>

FILE* g_hLog = NULL; <span class="comment">// Global handle to the application log file</span>

<span class="comment">// The following function writes an entry to the log file</span>
<span class="keywordtype">void</span> log_write(LPCTSTR szFormat, ...)
{
  <span class="keywordflow">if</span> (g_hLog == NULL) 
    <span class="keywordflow">return</span>; <span class="comment">// Log file seems to be closed</span>

  va_list args;
  va_start(args); 
  _vftprintf_s(g_hLog, szFormat, args);
  fflush(g_hLog);
}

<span class="comment">// Thread procedure</span>
DWORD WINAPI ThreadProc(LPVOID lpParam)
{
  log_write(_T(<span class="stringliteral">"Entering the thread proc\n"</span>));

  <span class="comment">// Define the infinite loop where some processing will be done </span>
  <span class="keywordflow">for</span>(;;)
  {
    <span class="comment">// There is a hidden error somewhere inside of the loop...</span>
    <span class="keywordtype">int</span>* p = NULL;
    *p = 13; <span class="comment">// This results in Access Violation</span>
  }    
   
  log_write(_T(<span class="stringliteral">"Leaving the thread proc\n"</span>));

  <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> _tmain(<span class="keywordtype">int</span> argc, _TCHAR* argv[])
{
  <span class="comment">// Open log file</span>
  errno_t err = _tfopen_s(&amp;g_hLog, _T(<span class="stringliteral">"log.txt"</span>), _T(<span class="stringliteral">"wt"</span>));
  <span class="keywordflow">if</span>(err!=0 || g_hLog==NULL)
  {
    _tprintf_s(_T(<span class="stringliteral">"Error opening log.txt\n"</span>));
    <span class="keywordflow">return</span> 1; <span class="comment">// Couldn't open log file</span>
  }

  log_write(_T(<span class="stringliteral">"Started successfully\n"</span>));

  <span class="comment">// Create the worker thread</span>
  HANDLE hWorkingThread = CreateThread(NULL, 0, 
           ThreadProc, (LPVOID)NULL, 0, NULL);

  log_write(_T(<span class="stringliteral">"Created working thread\n"</span>));

  <span class="comment">// There is a hidden error in the main() function</span>
  <span class="comment">// Call of _tprintf_s with NULL parameter</span>
  TCHAR* szFormatString = NULL;
  _tprintf_s(szFormatString);

  <span class="comment">// Wait until the worker thread is exited</span>
  WaitForSingleObject(hWorkingThread, INFINITE);

  log_write(_T(<span class="stringliteral">"Working thread has exited\n"</span>));

  <span class="comment">// Close the log file</span>
  <span class="keywordflow">if</span>(g_hLog!=NULL)
  {
    fclose(g_hLog);
    g_hLog = NULL;<span class="comment">// Clean up handle</span>
  }

  <span class="comment">// Exit</span>
  <span class="keywordflow">return</span> 0;
}
</pre></div><p>
We intentionally inserted the code that would cause an exception in both threads. In real-life programs such code always exist, even when you test your application very carefully.<p>
To enable crash reporting support in the application, you need to include CrashRpt header in the beginning of your code and insert some <a class="el" href="group___crash_rpt_a_p_i.html">CrashRpt Functions</a>. Below is the same code with CrashRpt API functions inserted.<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;windows.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;tchar.h&gt;</span>
<span class="comment">// Include CrashRpt Header </span>
<span class="preprocessor">#include "<a class="code" href="_crash_rpt_8h.html" title="Defines the interface for the CrashRpt.DLL.">CrashRpt.h</a>"</span>

FILE* g_hLog = NULL; <span class="comment">// Global handle to the application log file</span>

<span class="comment">// Define the callback function that will be called on crash</span>
BOOL WINAPI CrashCallback(LPVOID <span class="comment">/*lpvState*/</span>)
{  
  <span class="comment">// The application has crashed!</span>

  <span class="comment">// Close the log file here</span>
  <span class="comment">// to ensure CrashRpt is able to include it into error report</span>
  <span class="keywordflow">if</span>(g_hLog!=NULL)
  {
    fclose(g_hLog);
    g_hLog = NULL;<span class="comment">// Clean up handle</span>
  }

  <span class="comment">// Return TRUE to generate error report</span>
  <span class="keywordflow">return</span> TRUE;
}

<span class="comment">// The following function writes an entry to the log file</span>
<span class="keywordtype">void</span> log_write(LPCTSTR szFormat, ...)
{
  <span class="keywordflow">if</span> (g_hLog == NULL) 
    <span class="keywordflow">return</span>; <span class="comment">// Log file seems to be closed</span>

  va_list args; 
  va_start(args); 
  _vftprintf_s(g_hLog, szFormat, args);
  fflush(g_hLog);
}

<span class="comment">// Thread procedure</span>
DWORD WINAPI ThreadProc(LPVOID lpParam)
{
  <span class="comment">// Install exception handlers for this thread</span>
  <a class="code" href="group___crash_rpt_a_p_i.html#g6fe5cff31697f687b29dc73cd34d72b4" title="Installs exception handlers to the caller thread.">crInstallToCurrentThread2</a>(0);

  log_write(_T(<span class="stringliteral">"Entering the thread proc\n"</span>));

  <span class="comment">// Define the infinite loop where some processing will be done </span>
  <span class="keywordflow">for</span>(;;)
  {
    <span class="comment">// There is a hidden error somewhere inside of the loop...</span>
    <span class="keywordtype">int</span>* p = NULL;
    *p = 13; <span class="comment">// This results in Access Violation</span>
  }    
   
  log_write(_T(<span class="stringliteral">"Leaving the thread proc\n"</span>));

  <span class="comment">// Unset exception handlers before exiting the thread</span>
  <a class="code" href="group___crash_rpt_a_p_i.html#gaf56dbee81338534d96ab23f694be43c" title="Uninstalls C++ exception handlers from the current thread.">crUninstallFromCurrentThread</a>();    

  <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> _tmain(<span class="keywordtype">int</span> argc, _TCHAR* argv[])
{  
  <span class="comment">// Define CrashRpt configuration parameters</span>
  <a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html">CR_INSTALL_INFO</a> info;  
  memset(&amp;info, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html">CR_INSTALL_INFO</a>));  
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#9867d0b22e6f50ac3db844c297f230db" title="Size of this structure in bytes; must be initialized before using!">cb</a> = <span class="keyword">sizeof</span>(<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html">CR_INSTALL_INFO</a>);    
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#626bed9c6b114c92e3bcfa16990d6c0c" title="Name of application.">pszAppName</a> = _T(<span class="stringliteral">"MyApp"</span>);  
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#4e341f0ae33c88f65e770a69dbba300c" title="Application version.">pszAppVersion</a> = _T(<span class="stringliteral">"1.0.0"</span>);  
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#3ae88305c70b042bf0ea4a0a5131d4fd" title="Subject of crash report e-mail.">pszEmailSubject</a> = _T(<span class="stringliteral">"MyApp 1.0.0 Error Report"</span>);  
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#e1eb10fda8115ad82cee692d2837018d" title="E-mail address of crash reports recipient.">pszEmailTo</a> = _T(<span class="stringliteral">"myapp_support@hotmail.com"</span>);    
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#9708cd90ec937ff61ffdbc9f5dbb94c9" title="URL of server-side script (used in HTTP connection).">pszUrl</a> = _T(<span class="stringliteral">"http://myapp.com/tools/crashrpt.php"</span>);  
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#e05bbd707bd0dd3f778cf8c0db7f824a" title="User crash callback.">pfnCrashCallback</a> = CrashCallback;   
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#01d5bd46223beabcced7329662ef9837" title="Array of error sending transport priorities.">uPriorities</a>[<a class="code" href="_crash_rpt_8h.html#7cb7df55f0fa979d1d4f5899e64e81e1" title="Send error report via HTTP (or HTTPS) connection.">CR_HTTP</a>] = 3;  <span class="comment">// First try send report over HTTP </span>
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#01d5bd46223beabcced7329662ef9837" title="Array of error sending transport priorities.">uPriorities</a>[<a class="code" href="_crash_rpt_8h.html#8a9140d2d3fcc6c1903e6ebe4bb8843d" title="Send error report via SMTP connection.">CR_SMTP</a>] = 2;  <span class="comment">// Second try send report over SMTP  </span>
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#01d5bd46223beabcced7329662ef9837" title="Array of error sending transport priorities.">uPriorities</a>[<a class="code" href="_crash_rpt_8h.html#0874e8ec6bad8eee3121cd8044f2a5bb" title="Send error report via simple MAPI (using default mail client).">CR_SMAPI</a>] = 1; <span class="comment">// Third try send report over Simple MAPI    </span>
  <span class="comment">// Install all available exception handlers, use HTTP binary transfer encoding (recommended).</span>
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#1798fdbe4869846814ebe004a316037c" title="Flags.">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#7ca8f2bce377fc05441f10c235dd55e2" title="Install all possible exception handlers.">CR_INST_ALL_POSSIBLE_HANDLERS</a>;
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#1798fdbe4869846814ebe004a316037c" title="Flags.">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#322f7b37078003b52728dad7b26e1785" title="Use multi-part HTTP uploads with binary attachment encoding.">CR_INST_HTTP_BINARY_ENCODING</a>; 
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#1798fdbe4869846814ebe004a316037c" title="Flags.">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#92c65e94c4f6f1363644114be2c49f7a" title="Restart the application on crash.">CR_INST_APP_RESTART</a>; 
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#1798fdbe4869846814ebe004a316037c" title="Flags.">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#1d2fdb48ae4bf477109baf07b29dd26a" title="CrashRpt should send error reports that are waiting to be delivered.">CR_INST_SEND_QUEUED_REPORTS</a>; 
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#7d9dc7839f981433dda0be4d18b256c2" title="Command line for application restart (without executable name).">pszRestartCmdLine</a> = _T(<span class="stringliteral">"/restart"</span>);
  <span class="comment">// Define the Privacy Policy URL </span>
  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#19803bb5e7dd26da845219a6a689987c" title="URL of privacy policy agreement.">pszPrivacyPolicyURL</a> = _T(<span class="stringliteral">"http://myapp.com/privacypolicy.html"</span>); 
  
  <span class="comment">// Install exception handlers</span>
  <span class="keywordtype">int</span> nResult = <a class="code" href="group___crash_rpt_a_p_i.html#g24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions.">crInstall</a>(&amp;info);    
  <span class="keywordflow">if</span>(nResult!=0)  
  {    
    <span class="comment">// Something goes wrong. Get error message.</span>
    TCHAR szErrorMsg[512] = _T(<span class="stringliteral">""</span>);        
    <a class="code" href="group___crash_rpt_a_p_i.html#g062f47d5f7284d72793c60699c7caa33" title="Defines character set-independent mapping for crGetLastErrorMsgW() and crGetLastErrorMsgA()...">crGetLastErrorMsg</a>(szErrorMsg, 512);    
    _tprintf_s(_T(<span class="stringliteral">"%s\n"</span>), szErrorMsg);    
    <span class="keywordflow">return</span> 1;
  } 

  <span class="comment">// Add our log file to the error report</span>
  <a class="code" href="group___crash_rpt_a_p_i.html#g382c00cf76818ba1a66eb89715a030ea" title="Character set-independent mapping of crAddFile2W() and crAddFile2A() functions.">crAddFile2</a>(_T(<span class="stringliteral">"log.txt"</span>), NULL, _T(<span class="stringliteral">"Log File"</span>), <a class="code" href="_crash_rpt_8h.html#e365a56cd807acedceff109c06782bdc" title="Copy the file to the error report folder.">CR_AF_MAKE_FILE_COPY</a>);    

  <span class="comment">// We want the screenshot of the entire desktop is to be added on crash</span>
  <a class="code" href="group___crash_rpt_a_p_i.html#g7a2a09a4be002f99d1f224e5a5baae82" title="Adds a screenshot to the crash report.">crAddScreenshot</a>(<a class="code" href="_crash_rpt_8h.html#5d0f686c9cbb88bdc7425ab3b8bf7d1a" title="Take a screenshot of the virtual screen.">CR_AS_VIRTUAL_SCREEN</a>);   

  <span class="comment">// Add a named property that means what graphics adapter is</span>
  <span class="comment">// installed on user's machine</span>
  <a class="code" href="group___crash_rpt_a_p_i.html#g5bc9d5a06b3ef1bb62e61b109f890730" title="Character set-independent mapping of crAddPropertyW() and crAddPropertyA() functions...">crAddProperty</a>(_T(<span class="stringliteral">"VideoCard"</span>), _T(<span class="stringliteral">"nVidia GeForce 8600 GTS"</span>));

  <span class="comment">// The main code follows...</span>

  <span class="comment">// Open log file</span>
  errno_t err = _tfopen_s(&amp;g_hLog, _T(<span class="stringliteral">"log.txt"</span>), _T(<span class="stringliteral">"wt"</span>));
  <span class="keywordflow">if</span>(err!=0 || g_hLog==NULL)
  {
    _tprintf_s(_T(<span class="stringliteral">"Error opening log.txt\n"</span>));
    <span class="keywordflow">return</span> 1; <span class="comment">// Couldn't open log file</span>
  }

  log_write(_T(<span class="stringliteral">"Started successfully\n"</span>));

  <span class="comment">// Create the worker thread</span>
  HANDLE hWorkingThread = CreateThread(NULL, 0, 
           ThreadProc, (LPVOID)NULL, 0, NULL);

  log_write(_T(<span class="stringliteral">"Created working thread\n"</span>));

  <span class="comment">// There is a hidden error in the main() function</span>
  <span class="comment">// Call of _tprintf_s with NULL parameter</span>
  TCHAR* szFormatString = NULL;
  _tprintf_s(szFormatString);

  <span class="comment">// Wait until the worker thread is exited</span>
  WaitForSingleObject(hWorkingThread, INFINITE);

  log_write(_T(<span class="stringliteral">"Working thread has exited\n"</span>));

  <span class="comment">// Close the log file</span>
  <span class="keywordflow">if</span>(g_hLog!=NULL)
  {
    fclose(g_hLog);
    g_hLog = NULL;<span class="comment">// Clean up handle</span>
  }

  <span class="comment">// Unset exception handlers before exiting the main function</span>
  <a class="code" href="group___crash_rpt_a_p_i.html#gb5ff3a104014a1e138878a1882822442" title="Unsinstalls exception handlers previously installed with crInstall().">crUninstall</a>();

  <span class="comment">// Exit</span>
  <span class="keywordflow">return</span> 0;
}
</pre></div><p>
Before running the application, you should place the following files to the directory where your application executable file is located (for additional information, see <a class="el" href="preparing_to_software_release.html">Preparing to Software Release</a>):<p>
<ul>
<li><b>CrashRptXXXX.dll</b> (here and below XXXX should be replaced with the actual version of CrashRpt)</li><li><b>CrashSenderXXXX.exe</b> </li><li><b>dbghelp.dll</b> </li><li><b>crashrpt_lang.ini</b> </li></ul>
<p>
When files are copied, run the application. As error occurs, you should be able to see an error report window (for additional information, see <a class="el" href="error_report.html">About an Error Report</a>) </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sat Oct 22 17:37:43 2011 for CrashRpt by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9 </small></address>
</body>
</html>
